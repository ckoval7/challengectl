name: Docker Build Test

on:
  push:
    branches:
      - master
      - challengectl-v2
      - 'claude/**'
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - 'server/**'
      - 'frontend/**'
      - 'requirements*.txt'
  pull_request:
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - 'server/**'
      - 'frontend/**'
      - 'requirements*.txt'

jobs:
  docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check for Dockerfiles
        id: check_dockerfiles
        run: |
          if ls Dockerfile* 1> /dev/null 2>&1; then
            echo "dockerfiles_exist=true" >> $GITHUB_OUTPUT
            ls -la Dockerfile*
          else
            echo "dockerfiles_exist=false" >> $GITHUB_OUTPUT
            echo "No Dockerfiles found in repository"
          fi

      - name: Build Docker image (if Dockerfile exists)
        if: steps.check_dockerfiles.outputs.dockerfiles_exist == 'true'
        run: |
          for dockerfile in Dockerfile*; do
            if [ -f "$dockerfile" ]; then
              echo "Building with $dockerfile..."
              docker buildx build -f "$dockerfile" -t "challengectl:test-${dockerfile}" . || echo "Build failed for $dockerfile"
            fi
          done

      - name: Check for docker-compose files
        id: check_compose
        run: |
          if ls docker-compose*.yml 1> /dev/null 2>&1; then
            echo "compose_exists=true" >> $GITHUB_OUTPUT
            ls -la docker-compose*.yml
          else
            echo "compose_exists=false" >> $GITHUB_OUTPUT
            echo "No docker-compose files found"
          fi

      - name: Validate docker-compose files
        if: steps.check_compose.outputs.compose_exists == 'true'
        run: |
          for composefile in docker-compose*.yml; do
            if [ -f "$composefile" ]; then
              echo "Validating $composefile..."
              docker-compose -f "$composefile" config || echo "Validation failed for $composefile"
            fi
          done

      - name: Test container health
        if: steps.check_dockerfiles.outputs.dockerfiles_exist == 'true'
        continue-on-error: true
        run: |
          # Start a container and check if it stays running
          for dockerfile in Dockerfile*; do
            if [ -f "$dockerfile" ]; then
              IMAGE_NAME="challengectl:test-${dockerfile}"
              if docker images | grep -q "$IMAGE_NAME"; then
                echo "Testing container from $IMAGE_NAME..."
                docker run -d --name test-container-${dockerfile} "$IMAGE_NAME" || true
                sleep 5
                docker ps -a | grep test-container-${dockerfile} || true
                docker stop test-container-${dockerfile} 2>/dev/null || true
                docker rm test-container-${dockerfile} 2>/dev/null || true
              fi
            fi
          done
